<!DOCTYPE html>
<html lang="en">
<head>
    <title>InuLogs</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="./ZLGstatics/images/icons/favicon.ico" />

    <script src="./ZLGstatics/js/jquery-3.2.1.min.js"></script>
    <script src="./ZLGstatics/js/popper.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./ZLGstatics/css/bootstrap.min.css" />
    <script src="./ZLGstatics/js/bootstrap.min.js"></script>
    <!-- <script src="./ZLGstatics/signalr/signalr.js"></script> -->
    <script src="./ZLGstatics/js/moment.min.js"></script>

    <style>
        body {
            color: #000;
            overflow-x: hidden;
            height: 100%;
            background-color: #EBEFFB;
            background-repeat: no-repeat;
            font-family: 'Avenir Next LT Pro', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

            body[data-theme="dark"] {
                --logo: url(./ZLGstatics/images/inudogLogo.png) no-repeat;
            }

        fieldset {
            display: none
        }

            fieldset.show {
                display: block
            }

        select:focus,
        input:focus {
            -moz-box-shadow: none !important;
            -webkit-box-shadow: none !important;
            box-shadow: none !important;
            border: 1px solid #2196F3 !important;
            outline-width: 0 !important;
            font-weight: 400
        }

        button:focus {
            -moz-box-shadow: none !important;
            -webkit-box-shadow: none !important;
            box-shadow: none !important;
            outline-width: 0
        }

        .tabs {
            margin: 2px 5px 0px 5px;
            padding-bottom: 3px;
            cursor: pointer
        }

            .tabs:hover,
            .tabs.active {
                border-bottom: 1px solid #2196F3
            }

        a:hover {
            text-decoration: none;
            color: #1565C0
        }

        .box {
            margin-bottom: 10px;
            border-radius: 5px;
            padding: 10px
        }

        .modal-backdrop {
            background-color: #000000
        }

        .line {
            background-color: #CFD8DC;
            height: 1px;
            width: 100%
        }

        @media screen and (max-width: 768px) {
            .tabs h6 {
                font-size: 12px
            }
        }

        .dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        pre {
            word-wrap: break-word;
            height: auto;
            max-height: 200px;
            overflow: auto
        }

        .logo {
            height: 35px;
        }

        /*Skeleton Loader*/
        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
        }

        @keyframes skeleton-loading {
            0% {
                background-color: hsl(200, 20%, 80%);
            }

            100% {
                background-color: hsl(200, 20%, 95%);
            }
        }

        .skeleton-text {
            width: 100%;
            height: 3.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.3rem;
        }

        .label {
            display: inline-block;
            width: 150px; /* 根据实际需要调整宽度 */
            text-align: left;
        }
    </style>


</head>
<body>
    <section class="ftco-section pb-5">
        <div style="">
            <nav class="navbar navbar-expand-lg navbar-light bg-light" style="background-color: #E4F2FD;">
                <a class="navbar-brand" href="#"><img src="./ZLGstatics/images/icons/favicon.ico" class="logo" alt="InuLogs Logo" /></a>
                <h5 class="font-weight-bold" style="padding-top: 7px;">InuLogs</h5>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <div class="navbar-nav mr-auto">
                        <form class="form-inline">
                            <div class="row d-flex float-right nav nav-tabs mx-1 mx-sm-3 mb-0 pb-0 border-0" style="margin-top:9px">
                                <a data-toggle="tab" href="#requestTab" onclick="ChangeSearch(1)" style="color: black; text-decoration: none; text-underline-offset: 5px">
                                    <div class="active">
                                        <h6 id="reqLog" class="">请求日志</h6>
                                    </div>
                                </a>
                                <a data-toggle="tab" class="ml-3" href="#exceptionTab" onclick="ChangeSearch(2)" style="color: black; text-decoration: none; text-underline-offset: 5px">
                                    <div class="">
                                        <h6 id="excptLog" class="">异常日志</h6>
                                    </div>
                                </a>
                                <a data-toggle="tab" class="ml-3" href="#incodeTab" onclick="ChangeSearch(3)" style="color: black; text-decoration: none; text-underline-offset: 5px">
                                    <div class="">
                                        <h6 id="inCodeLog" class="">编译日志</h6>
                                    </div>
                                </a>
                            </div>
                        </form>
                    </div>
                    <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
                        <li class="nav-item p-1">
                            <select id="myLogLevelDropDown" class="form-control m-1" aria-label="Default select Log Level">
                                <option selected>全部</option>
                                <option value="Info">信息</option>
                                <option value="Warning">警告</option>
                                <option value="Error">错误</option>
                            </select>
                        </li>
                        <li class="nav-item p-1">
                            <select id="myVerbDropDown" class="form-control m-1" aria-label="Default select HTTP Verb">
                                <option selected>全部</option>
                                <option value="POST">POST</option>
                                <option value="GET">GET</option>
                                <option value="PUT">PUT</option>
                                <option value="PATCH">PATCH</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </li>
                        <li class="nav-item p-1">
                            <select id="myStatusCodeDropDown" class="form-control m-1" aria-label="Default select HTTP Verb">
                                <option selected>全部</option>
                                <option value="200">200</option>
                                <option value="201">201</option>
                                <option value="301">301</option>
                                <option value="302">302</option>
                                <option value="400">400</option>
                                <option value="401">401</option>
                                <option value="404">404</option>
                                <option value="405">405</option>
                                <option value="407">407</option>
                                <option value="410">410</option>
                                <option value="415">415</option>
                                <option value="500">500</option>
                                <option value="503">503</option>
                            </select>
                        </li>
                        <li class="nav-item p-1">
                            <select id="myResultDropDown" class="form-control m-1" aria-label="Default select HTTP Verb">
                                <option value="-1" selected>全部</option>
                                <option value="0">结果正确</option>
                                <option value="1">结果错误</option>
                            </select>
                        </li>
                        <li class="nav-item p-1">
                            <input type="text" name="search" class="form-control m-1" id="searchString" />
                        </li>
                        <li class="nav-item p-1">
                            <button id="logSearchbtn" onclick="LogSearch()" class="btn btn-outline-primary m-1">搜索</button>
                        </li>
                        <li class="nav-item p-1">
                            <div class="btn-group m-1">
                                <button class="btn btn-outline-secondary" onclick="logOut()" type="submit">退出</button>
                                <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="sr-only">Toggle Dropdown</span>
                                </button>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item" onclick="backToList(event)" href="#">重置条件</a>
                                    <a class="dropdown-item text-danger" data-toggle="modal" data-target="#clearLogsModal" href="#">清除日志</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
        <div class="container">


            <div class="tab-content">
                <div id="requestTab" class="tab-pane fade in active show">
                    <div class="row" style="height:20px">
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="table">
                                <table class="table table-hover table-responsive-lg table-lg shadow p-3 mb-5 bg-light rounded">
                                    <thead class="thead-light">
                                        <tr>
                                            <th scope="col">请求方法</th>
                                            <th scope="col">地址</th>
                                            <th scope="col">状态码</th>
                                            <th scope="col">耗时</th>
                                            <th scope="col">请求时间</th>
                                            <th scope="col">结果错误</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                    </tbody>
                                </table>
                            </div>
                            <div id="rqLoader">
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col text-left">
                            <button id="prev" class="btn btn-primary m-1" onclick="prevPage()">上一页</button>
                        </div>
                        <div class="col text-center">
                            <p class="lead text-muted" id="pageMap"></p>
                        </div>
                        <div class="col text-right">
                            <button id="next" class="btn btn-primary m-1" onclick="nextPage()">下一页</button>
                        </div>
                    </div>
                </div>
                <div id="exceptionTab" class="tab-pane fade">
                    <div class="row" style="height:20px">
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="table">
                                <table class="table table-hover table-responsive-lg table-lg shadow p-3 mb-5 bg-light rounded">
                                    <thead class="thead-light">
                                        <tr>
                                            <th scope="col">源</th>
                                            <th scope="col">消息</th>
                                            <th scope="col">类型</th>
                                            <th scope="col">追踪</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBodyEx">
                                    </tbody>
                                </table>
                            </div>
                            <div id="exLoader">
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col text-left">
                            <button id="exPrev" class="btn btn-primary m-1" onclick="exPrevPage(event)">上一页</button>
                        </div>
                        <div class="col text-center">
                            <p class="lead text-muted" id="exPageMap"></p>
                        </div>
                        <div class="col text-right">
                            <button id="exNext" class="btn btn-primary m-1" onclick="exNextPage(event)">下一页</button>
                        </div>
                    </div>
                </div>
                <div id="incodeTab" class="tab-pane fade">
                    <div class="row" style="height:20px">
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="table table-responsive">
                                <table class="table table-hover table-lg shadow p-3 mb-5 bg-light rounded">
                                    <thead class="thead-light">
                                        <tr>
                                            <th scope="col">发生处</th>
                                            <th scope="col">起源</th>
                                            <th scope="col">方法</th>
                                            <th scope="col">日志级别</th>
                                            <th scope="col">消息</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBodyInCode">
                                    </tbody>
                                </table>
                            </div>
                            <div id="incodeLoader">
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col text-left">
                            <button id="exPrev" class="btn btn-primary m-1" onclick="inCodePrevPage(event)">上一页</button>
                        </div>
                        <div class="col text-center">
                            <p class="lead text-muted" id="inCodePageMap"></p>
                        </div>
                        <div class="col text-right">
                            <button id="exNext" class="btn btn-primary m-1" onclick="inCodeNextPage(event)">下一页</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">InuLogs</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body shadow-lg">
                    <div class="row">
                        <div class="col-md-12 m">
                            <p><b class="label">请求URL: </b> <span id="host"></span></p>
                            <p><b class="label">请求方法: </b> <span id="path"></span></p>
                            <p><b class="label">查询字符串参数: </b> <span id="query"></span></p>
                            <p><b class="label">请求方法: </b> <span id="method"></span></p>
                            <p><b class="label">远程地址: </b> <span id="ip"></span></p>
                            <p><b class="label">Status Code: </b> <span id="statusCode"></span></p>
                            <p><b class="label">耗时: </b> <span id="time"></span></p>
                            <p><b class="label">请求时间: </b> <span id="startTime"></span></p>

                        </div>
                        <div class="col-md-12 purplebg m mt-3">
                            <div class="row d-flex justify-content-between mx-1 mx-sm-3 mb-0 pb-0 border-0">
                                <div class="tabs active" id="tab01">
                                    <h6 class="font-weight-bold">请求</h6>
                                </div>
                                <div class="tabs" id="tab02">
                                    <h6 class="text-muted">响应</h6>
                                </div>
                                <div class="tabs" id="tab03">
                                    <h6 class="text-muted">请求头</h6>
                                </div>
                            </div>
                            <div class="line mb-3"></div>

                            <div class="modal-body p-0">
                                <fieldset id="tab011" class="show">
                                    <div class="">
                                        <a href="#" id="reqBodyCopy" onclick="copyToClipboard(event, 'reqBody', 'reqBodyCopy')" style="display:none" class="float-right">Copy</a>
                                        <p class="lead">请求 Body: </p>
                                        <pre id="reqBody" class="bg-light p-2"></pre>
                                    </div>
                                </fieldset>
                                <fieldset class="" id="tab021">
                                    <div class="">
                                        <a href="#" id="resBodyCopy" onclick="copyToClipboard(event, 'resBody', 'resBodyCopy')" style="display:none" class="float-right">Copy</a>
                                        <p class="lead">响应 Body: </p>
                                        <pre id="resBody" class="bg-light p-2"></pre>
                                    </div>
                                </fieldset>
                                <fieldset id="tab031">
                                    <div class="">
                                        <p class="lead">请求头: </p>
                                        <pre id="reqHd" class="bg-light p-2"></pre>
                                        <p class="lead mt-3">响应头: </p>
                                        <pre id="resHd" class="bg-light p-2"></pre>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button id="retryRequestButton" class="btn btn-primary">重试请求</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="myExceptionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">InuLogs Exceptions</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body shadow-lg">
                    <div class="">
                        <p><b class="label">Message: </b> <span id="exMessage"></span></p>
                        <p><b class="label">TypeOf: </b> <span id="exTypeOf"></span></p>
                        <p><b class="label">Source: </b> <span id="exSource"></span></p>
                        <p><b class="label">Method: </b> <span id="exMethod"></span></p>
                        <p><b class="label">Path: </b> <span id="exPath"></span></p>
                        <p><b class="label">Query: </b> <span id="exQuery"></span></p>
                        <p><b class="label">Encountered At: </b> <span id="exTime"></span></p>
                    </div>
                    <div class="">
                        <a href="#" id="exStackTraceCopy" onclick="copyToClipboard(event, 'exStackTrace', 'exStackTraceCopy')" style="display:none" class="float-right">Copy</a>
                        <p class="lead"><b>Stack Trace:</b> </p>
                        <pre id="exStackTrace" class="bg-light p-2"></pre>

                        <a href="#" id="exReqBodyCopy" onclick="copyToClipboard(event, 'exReqBody', 'exReqBodyCopy')" style="display:none" class="float-right">Copy</a>
                        <p class="lead"><b>Request Body:</b> </p>
                        <pre id="exReqBody" class="bg-light p-2"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="myInCodeModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">In-Code Log</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body shadow-lg">
                    </button> -->
                    <div class="">
                        <p><b class="label">Event Id: </b> <span id="incodeEventId"></span></p>
                        <p><b class="label">From File: </b> <span id="incodeFrom"></span></p>
                        <p><b class="label">Method: </b> <span id="incodeMethod"></span></p>
                        <p><b class="label">Line: </b> <span id="incodeLine"></span></p>
                        <p><b class="label">Log Level: </b> <span id="incodeLogLevel"></span></p>
                        <p><b class="label">Encountered At: </b> <span id="incodeTime"></span></p>
                    </div>
                    <div class="">
                        <a href="#" id="incodeMessageCopy" onclick="copyToClipboard(event, 'incodeMessage', 'incodeMessageCopy')" style="display:none" class="float-right">Copy</a>
                        <p class="lead"><b>Message:</b> </p>
                        <pre id="incodeMessage" class="bg-light p-2"></pre>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="myLoginModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">InuLogs 登陆</h5>
                </div>
                <div class="modal-body">
                    <div class="">
                        <form id="myLoginForm">
                            <input class="form-control m-1 mb-3" type="text" placeholder="用户名" name="uname" id="uname" required>
                            <input class="form-control m-1" type="password" placeholder="密码" name="psw" id="psw" required>

                        </form>

                        <button class="btn btn-primary btn-sm m-1 mt-3" style="width:100%" onclick="login()" type="submit">登录</button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="clearLogsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">清除日志</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <div class="mx-auto text-center">
                        <h5>您确定要清除所有日志吗?</h5>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="clearLogs()">确认</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="retryModal" tabindex="-1" role="dialog" aria-labelledby="retryModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">重试请求</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body shadow-lg">
                    <form id="retryForm">
                        <div class="form-group">
                            <label for="retryMethod">请求方法</label>
                            <select id="retryMethod" class="form-control">
                                <option>GET</option>
                                <option>POST</option>
                                <option>PUT</option>
                                <option>PATCH</option>
                                <option>DELETE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="retryURL">请求URL</label>
                            <input type="text" class="form-control" id="retryURL" placeholder="Enter URL">
                        </div>
                        <div class="form-group">
                            <label for="retryHeaders">请求头</label>
                            <textarea class="form-control" id="retryHeaders" rows="3" placeholder="Enter headers"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="retryBody">请求体</label>
                            <textarea class="form-control" id="retryBody" rows="3" placeholder="Enter body"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="retryBody">响应结果</label>
                            <pre id="retryReponse" class="bg-light p-2" style="height: 200px; overflow-y: scroll; white-space: pre-wrap;"></pre>
                            <!-- <textarea class="form-control" id="retryReponse" rows="3" placeholder="Enter body"></textarea> -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="retryRequestSend">发送</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="requestTips" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content bg-success text-white">
                <div class="modal-body">
                    操作成功！
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="requesterroeTips" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content bg-danger text-white">
                <div class="modal-body">
                    出现错误！
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var searchType = 1;
        $(document).ready(function () {
            $('#myVerbDropDown').show();
            $('#myStatusCodeDropDown').show();
            $('#myResultDropDown').show();
            $('#searchString').show();
            $('#logSearchbtn').show();
            $('#exSearchbtn').hide();
            $('#myLogLevelDropDown').hide();
            $('#inCodeSearchbtn').hide();

            $("#myTab a").click(function (e) {
                e.preventDefault();
                $(this).tab("show");
            });
            $('#retryModal').on('hidden.bs.modal', function (e) {
                $('#myModal').modal('show');
            })
            $(".tabs").click(function () {
                $(".tabs").removeClass("active");
                $(".tabs h6").removeClass("font-weight-bold");
                $(".tabs h6").addClass("text-muted");
                $(this).children("h6").removeClass("text-muted");
                $(this).children("h6").addClass("font-weight-bold");
                $(this).addClass("active");
                current_fs = $(".active");
                next_fs = $(this).attr('id');
                next_fs = "#" + next_fs + "1";
                $("fieldset").removeClass("show");
                $(next_fs).addClass("show");
                current_fs.animate({}, {
                    step: function () {
                        current_fs.css({
                            'display': 'none',
                            'position': 'relative'
                        });
                        next_fs.css({
                            'display': 'block'
                        });
                    }
                });

            });
            hasAuth().then(
                (data) => {
                    if (data === false) {
                        $('#myLoginModal').modal('show');
                    } else {
                        getLogs();
                        getExceptionLogs();
                        getInCodeLogs();
                    }
                })
        });

        function ChangeSearch(type) {
            $('#searchString').val("");
            if (type == 1) {
                searchType = 1
                $('#myVerbDropDown').show();
                $('#myStatusCodeDropDown').show();
                $('#myResultDropDown').show();
                $('#exSearchbtn').hide();
                $('#myLogLevelDropDown').hide();
                $('#inCodeSearchbtn').hide();
            }
            if (type == 2) {
                searchType = 2
                $('#myVerbDropDown').hide();
                $('#myStatusCodeDropDown').hide();
                $('#myResultDropDown').hide();
                $('#exSearchbtn').show();
                $('#myLogLevelDropDown').hide();
                $('#inCodeSearchbtn').hide();
            }
            if (type == 3) {
                searchType = 3
                $('#myVerbDropDown').hide();
                $('#myStatusCodeDropDown').hide();
                $('#myResultDropDown').hide();
                $('#exSearchbtn').hide();
                $('#myLogLevelDropDown').show();
                $('#inCodeSearchbtn').show();
            }
        }

        function showRetryModal(record) {
            $('#retryReponse').text('');
            // 从记录中获取请求信息
            let method = record.method;
            let url = record.scheme + "://" + record.host + record.path;
            let headers = record.requestHeaders;
            let body = record.requestBody;
            if (record.queryString && record.queryString !== '') {
                url = url + record.queryString;
            }
            // 填充到模态窗口
            $('#retryMethod').val(method);
            $('#retryURL').val(url);
            $('#retryHeaders').val(headers);
            $('#retryBody').val(body);

            // 显示模态窗口
            $('#retryModal').modal('show');
        }

        function retryRequest(data) {
            var $btn = $('#retryRequestSend');
            $btn.prop('disabled', true); // 禁用按钮
            $btn.html('发送中...'); // 更改按钮文本
            event.stopPropagation();
            var requestData = {
                method: $('#retryMethod').val(),
                url: $('#retryURL').val(),
                headers: $('#retryHeaders').val(),
                body: $('#retryBody').val()
            };
            $.ajax({
                type: "POST",
                url: "./ZLinupage/RequestRetry",
                data: JSON.stringify(requestData),
                contentType: "application/json",
                context: document.body,
                success: function (data) {
                    $('#requestTips').modal('show');
                    //JSON.parse(element.innerText)
                    //JSON.stringify(data, null, 4)
                    $('#retryReponse').text(JSON.stringify(JSON.parse(data), null, 4));
                    $btn.prop('disabled', false); // 启用按钮
                    $btn.html('发送');
                    setTimeout(function () {
                        $('#requestTips').modal('hide');
                    }, 3000);
                    //window.location.reload()
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $('#requesterroeTips').modal('show');
                    $('#retryReponse').text(error);
                    setTimeout(function () {
                        $('#requesterroeTips').modal('hide');
                    }, 3000);
                    $btn.prop('disabled', false); // 启用按钮
                    $btn.html('发送');
                }
            });
        }

        var pageIndex = 1;
        var exPageIndex = 1;
        var inCodePageIndex = 1;

        $("#myVerbDropDown").change(function (event) {
            $('#tableBody').empty();
            if ($("#myVerbDropDown")[0].selectedIndex === 0) {
                getLogs($('#searchString').val(), "", $('#myStatusCodeDropDown').val() == "全部" ? "" : $('#myStatusCodeDropDown').val(), $('#myResultDropDown').val())
            } else {
                filterVerb($(this).val());
            }
        });

        $("#myStatusCodeDropDown").change(function (event) {
            $('#tableBody').empty();
            if ($("#myStatusCodeDropDown")[0].selectedIndex === 0) {
                getLogs($('#searchString').val(), $('#myVerbDropDown').val() == "全部" ? "" : $('#myVerbDropDown').val(), "", $('#myResultDropDown').val())
            } else {
                filterStatusCode($(this).val());
            }
        });
        $("#myResultDropDown").change(function (event) {
            $('#tableBody').empty();
            if ($("#myResultDropDown")[0].selectedIndex === 0) {
                getLogs($('#searchString').val(), $('#myVerbDropDown').val() == "全部" ? "" : $('#myVerbDropDown').val(), "", $('#myResultDropDown').val())
            } else {
                filterResult($(this).val());
            }
        });
        $("#myLogLevelDropDown").change(function (event) {
            $('#tableBodyInCode').empty();
            if ($("#myLogLevelDropDown")[0].selectedIndex === 0) {
                getInCodeLogs($('#searchString').val(), "")
            } else {
                filterLogLevel($(this).val());
            }
        });

        function shouldShowOnFiltered(logType, log) {
            shouldShow = true

            if (logType === "rqLog") {

                searchString = $('#searchString').val()
                statusCodeString = $('#myStatusCodeDropDown').val()
                verbString = $('#myVerbDropDown').val()

                if (!searchString && statusCodeString === "全部" && verbString === "全部") {
                    return true;
                }

                searchString = searchString.toLowerCase();

                if (searchString && (log.path?.toLowerCase().includes(searchString) || log.method?.toLowerCase().includes(searchString) ||
                    (log.queryString && log.queryString?.toLowerCase().includes(searchString)))) {

                    shouldShow &= true;

                }

                if (verbString !== "全部") {
                    if (log.method?.toLowerCase() !== verbString.toLowerCase()) {
                        shouldShow &= false
                    }
                }

                if (statusCodeString !== "全部") {
                    if (log.responseStatus != statusCodeString) {
                        shouldShow &= false
                    }
                }


            } else if (logType === "exLog") {


                searchString = $('#searchString').val()

                if (!searchString) {
                    return true;
                }

                searchString = searchString.toLowerCase()
                if (log.message.toLowerCase().includes(searchString) || log.stackTrace.includes(searchString) || log.source.includes(searchString)) {
                    return true;
                }

            } else if (logType === "log") {

                searchString = $('#searchString').val()
                logLevelString = $('#myLogLevelDropDown').val()

                if (!searchString && logLevelString === "全部") {
                    return true;
                }

                searchString = searchString.toLowerCase();
                logLevelString = logLevelString.toLowerCase();

                if ((searchString && (log.message.toLowerCase().includes(searchString) || log.callingMethod.toLowerCase().includes(searchString) ||
                    log.callingFrom.toLowerCase().includes(searchString) ||
                    (log.eventId && log.eventId.toLowerCase().includes(searchString)))) && (logLevelString !== "全部" && log.logLevel.toLowerCase() === logLevelString)) {
                    return true;
                }

            }

            return shouldShow
        }

        function getLogs(searchString = "", verb = "", statusCode = "", resultCode = -1) {
            $('#rqLoader').show();
            $.ajax({
                type: "GET",
                url: "./ZLinupage?pageNumber=" + pageIndex + "&searchString=" + searchString + "&verbString=" + verb + "&statusCode=" + statusCode + "&resultCode=" + resultCode,
                context: document.body,
                success: function (data) {
                    var totalPages = data.totalPages === 0 ? 1 : data.totalPages
                    $('#pageMap').text("Page " + data.pageIndex + " of " + totalPages);
                    if (data.hasNext === false) {
                        $('#next').hide();
                    }
                    else {
                        $('#next').show();
                    }

                    if (data.hasPrevious === false) {
                        $('#prev').hide();
                    }
                    else {
                        $('#prev').show();
                    }

                    $('#rqLoader').hide();
                    for (var i = 0; i < data.logs.length; i++) {
                        var resultExceptionColor = data.logs[i].resultException === 1 ? "background-color: red" : "background-color: green";
                        const firstDigitStr = String(data.logs[i].responseStatus)[0];
                        var statusColor = firstDigitStr === '2' ? "text-success" : firstDigitStr === '1' || firstDigitStr === '3' ? "text-primary" : "text-danger";
                        const tr = $("<tr data-toggle='modal' data-target='#myModal' aria-expanded='false' aria-controls='collapse" + i + "' class='collapsed'>" +
                            "<td><b>" + data.logs[i].method + "</b></td><td>" + truncate(data.logs[i].path, 50) + "</td><td><b class='" + statusColor + "'> " + data.logs[i].responseStatus + "</b ></td ><td>" + data.logs[i].timeSpent + "</td><td>" + moment(data.logs[i].startTime).format('YYYY-MM-DD HH:mm:ss') + "</td><td><span class='dot' style='" + resultExceptionColor + "'></span></td></tr > ");
                        tr.on('click', populateModal.bind(null, data.logs[i]));
                        $('#tableBody').append(tr);
                    }
                },
                error: function (error) {
                    $('#rqLoader').hide();
                    if (error.status === 401) {
                        $('#myLoginModal').modal('show');
                    }
                }
            });
        }

        function getExceptionLogs(searchString = "") {
            $('#exLoader').show();
            $.ajax({
                type: "GET",
                url: "./ZLinupage/Exceptions?pageNumber=" + exPageIndex + "&searchString=" + searchString,
                context: document.body,
                success: function (data) {
                    var totalPages = data.totalPages === 0 ? 1 : data.totalPages
                    $('#exPageMap').text("Page " + data.pageIndex + " of " + totalPages);
                    if (data.hasNext === false) {
                        $('#exNext').hide();
                    }
                    else {
                        $('#exNext').show();

                    }

                    if (data.hasPrevious === false) {
                        $('#exPrev').hide();
                    }
                    else {
                        $('#exPrev').show();
                    }

                    $('#exLoader').hide();

                    for (var i = 0; i < data.logs.length; i++) {
                        const tr = $("<tr data-toggle='modal' data-target='#myExceptionModal' aria-expanded='false' aria-controls='collapse" + i + "' class='collapsed'>" +
                            "<td><b>" + data.logs[i].source + "</b></td><td>" + truncate(data.logs[i].message, 50) + "</td><td>" + data.logs[i].typeOf + "</td><td>" + moment(data.logs[i].encounteredAt).format('YYYY-MM-DD HH:mm:ss') + "</td></tr > ");
                        tr.on('click', populateExceptionModal.bind(null, data.logs[i]));
                        $('#tableBodyEx').append(tr);
                    }
                },
                error: function (error) {
                    $('#exLoader').hide();
                    if (error.status === 401) {
                        $('#myLoginModal').modal('show');
                    }
                }
            });
        }
        function getInCodeLogs(searchString = "", logLevelString = "") {
            $('#incodeLoader').show();
            $.ajax({
                type: "GET",
                url: "./ZLinupage/Logs?pageNumber=" + inCodePageIndex + "&searchString=" + searchString + "&logLevelString=" + logLevelString,
                context: document.body,
                success: function (data) {
                    var totalPages = data.totalPages === 0 ? 1 : data.totalPages
                    $('#inCodePageMap').text("Page " + data.pageIndex + " of " + totalPages);
                    if (data.hasNext === false) {
                        $('#inCodeNext').hide();
                    }
                    else {
                        $('#inCodeNext').show();

                    }

                    if (data.hasPrevious === false) {
                        $('#inCodePrev').hide();
                    }
                    else {
                        $('#inCodePrev').show();
                    }

                    $('#incodeLoader').hide();

                    for (var i = 0; i < data.logs.length; i++) {
                        const tr = $("<tr data-toggle='modal' data-target='#myInCodeModal' aria-expanded='false' aria-controls='collapse" + i + "' class='collapsed'>" +
                            "<td><b>" + moment(data.logs[i].timestamp).format('YYYY-MM-DD HH:mm:ss') + "</b></td><td>" + (data.logs[i].callingFrom ??= '') + "\nLine:" + data.logs[i].lineNumber + "</td><td>" + (data.logs[i].callingMethod ??= '') + "</td><td>" + data.logs[i].logLevel + "</td><td>" + truncate(data.logs[i].message, 50) + "</td></tr > ");
                        tr.on('click', populateInCodeModal.bind(null, data.logs[i]));
                        $('#tableBodyInCode').append(tr);
                    }
                },
                error: function (error) {
                    $('#incodeLoader').hide();
                    if (error.status === 401) {
                        $('#myLoginModal').modal('show');
                    }
                }
            });
        }


        function clearLogs() {
            $.ajax({
                type: "POST",
                url: "./ZLinupage/ClearLogs",
                success: function (data) {
                    window.location.reload()
                },
                error: function (error) {
                    if (error.status === 401) {
                        $('#myLoginModal').modal('show');
                    }
                }
            });
        }
        function LogSearch() {
            if (searchType == 1) {
                pageIndex = 1;
                $('#tableBody').empty();
                var ss = $('#searchString').val();
                getLogs(ss, $('#myVerbDropDown').val() == "全部" ? "" : $('#myVerbDropDown').val(), $('#myStatusCodeDropDown').val() == "全部" ? "" : $('#myStatusCodeDropDown').val(), $('#myResultDropDown').val());
            }
            if (searchType == 2) {
                $('#tableBodyEx').empty();
                exPageIndex = 1;
                var ss = $('#searchString').val();
                getExceptionLogs(ss, $('#myLogLevelDropDown').val() == "全部" ? "" : $('#myLogLevelDropDown').val());
            }
            if (searchType == 3) {
                $('#tableBodyInCode').empty();
                inCodePageIndex = 1;
                var ss = $('#searchString').val();
                getInCodeLogs(ss);
            }

        }

        function filterVerb(verbString) {
            pageIndex = 1;
            $('#tableBody').empty();
            getLogs($('#searchString').val(), verbString, $('#myStatusCodeDropDown').val() == "全部" ? "" : $('#myStatusCodeDropDown').val(), $('#myResultDropDown').val());
        }

        function filterStatusCode(statusCodeString) {
            pageIndex = 1;
            $('#tableBody').empty();
            getLogs($('#searchString').val(), $('#myVerbDropDown').val() == "全部" ? "" : $('#myVerbDropDown').val(), statusCodeString, $('#myResultDropDown').val());
        }

        function filterResult(result) {
            pageIndex = 1;
            $('#tableBody').empty();
            getLogs($('#searchString').val(), $('#myVerbDropDown').val() == "全部" ? "" : $('#myVerbDropDown').val(), $('#myStatusCodeDropDown').val() == "全部" ? "" : $('#myStatusCodeDropDown').val(), result);
        }

        function filterLogLevel(logLevelString) {
            inCodePageIndex = 1;
            $('#tableBodyInCode').empty();
            getInCodeLogs($('#searchString').val(), logLevelString);
        }

        function nextPage() {
            ++pageIndex;
            $('#tableBody').empty();
            getLogs($('#searchString').val(), $('#myVerbDropDown').val() == "全部" ? "" : $('#myVerbDropDown').val(), $('#myStatusCodeDropDown').val() == "全部" ? "" : $('#myStatusCodeDropDown').val(), $('#myResultDropDown').val());
        }

        function prevPage() {
            if (pageIndex > 1)
                --pageIndex;
            $('#tableBody').empty();
            getLogs($('#searchString').val(), $('#myVerbDropDown').val() == "全部" ? "" : $('#myVerbDropDown').val(), $('#myStatusCodeDropDown').val() == "全部" ? "" : $('#myStatusCodeDropDown').val(), $('#myResultDropDown').val());
        }

        function exNextPage(e) {
            ++exPageIndex;
            $('#tableBodyEx').empty();
            getExceptionLogs($('#searchString').val());
        }

        function exPrevPage(e) {
            if (exPageIndex > 1)
                --exPageIndex;
            $('#tableBodyEx').empty();
            getExceptionLogs($('#searchString').val());
        }

        function inCodeNextPage(e) {
            ++inCodePageIndex;
            $('#tableBodyInCode').empty();
            getInCodeLogs($('#searchString').val());
        }

        function inCodePrevPage(e) {
            if (inCodePageIndex > 1)
                --inCodePageIndex;
            $('#tableBodyInCode').empty();
            getInCodeLogs($('#searchString').val());
        }

        function backToList(e) {
            pageIndex = 1;
            inCodePageIndex = 1;
            exPageIndex = 1;
            $('#tableBody').empty();
            $('#tableBodyEx').empty();
            $('#tableBodyInCode').empty();
            getLogs();
            getExceptionLogs();
            getInCodeLogs();

            $('#searchString').val("");
            $('#myVerbDropDown').val("全部");
            $('#myStatusCodeDropDown').val("全部");
            $('#myLogLevelDropDown').val("全部");
            $('#myResultDropDown').val(-1)
            e = e || window.event;
            e.preventDefault();
        }

        function logOut() {
            $.ajax({
                type: "GET",
                url: "./ZLinupage/LogOut",
                success: function (data) {
                    window.location.reload()
                }
            });
        }

        function login() {
            var form = document.querySelector('form')
            form.reportValidity()
            if (form.checkValidity()) {
                $.ajax({
                    type: "POST",
                    url: "./ZLinupage/Auth",
                    data: {
                        username: $("#uname").val(),
                        password: $("#psw").val()
                    },
                    context: document.body,
                    success: function (data) {

                        window.location.reload()
                    }
                });
            }

        }

        function hasAuth() {
            return new Promise(function (resolve, reject) {
                $.ajax({
                    type: "GET",
                    url: "./ZLinupage/IsAuth",
                    success: function (data) {
                        resolve(data) // Resolve promise and when success
                    },
                    error: function (err) {
                        reject(err) // Reject the promise and go to catch()
                    }
                });
            });
        }



        function populateModal(data) {
            $('#host').text(data.host);
            $('#path').text(data.path);
            $('#query').text(data.queryString);
            $('#method').text(data.method);
            $('#ip').text(data.ipAddress);
            $('#statusCode').text(data.responseStatus);
            $('#time').text(data.timeSpent);
            $('#startTime').text(moment(data.startTime).format('YYYY-MM-DD HH:mm:ss'));

            $('#reqHd').text(data.requestHeaders);
            $('#resHd').text(data.responseHeaders);
            $('#reqBody').text(data.requestBody);

            $('#resBody').text(data.responseBody);
            $('#retryRequestButton').on('click', function (event) {
                if (data) {
                    $('#myModal').modal('hide')
                    showRetryModal(data);
                } else {
                    console.log('没有可重试的请求记录');
                }
            });
            $('#retryRequestSend').off('click').on('click', function (event) {
                if (data) {
                    retryRequest(data);
                } else {
                    console.log('没有可重试的请求记录');
                }
            });

            // $('#retryRequestSend').on('click', function (event) {
            //     if (data) {
            //         retryRequest(data);
            //     } else {
            //         console.log('没有可重试的请求记录');
            //     }
            // });
            if (data.responseBody != null && data.responseBody !== "") {
                document.getElementById("resBodyCopy").style.display = "block";
                var element = document.getElementById("resBody");
                if (data.responseBody.includes("{")) {
                    var obj = JSON.parse(element.innerText);
                    element.innerHTML = JSON.stringify(obj, undefined, 2);
                }
            } else {
                document.getElementById("resBodyCopy").style.display = "none";
            }
            if (data.requestBody != null && data.requestBody !== "") {
                document.getElementById("reqBodyCopy").style.display = "block";
                var element2 = document.getElementById("reqBody");
                if (data.requestBody.includes("{")) {
                    var obj2 = JSON.parse(element2.innerText);
                    element2.innerHTML = JSON.stringify(obj2, undefined, 2);
                }
            } else {
                document.getElementById("reqBodyCopy").style.display = "none";
            }
        }

        function populateExceptionModal(data) {
            $('#exMessage').text(data.message);
            $('#exTypeOf').text(data.typeOf);
            $('#exSource').text(data.source);
            $('#exTime').text(moment(data.encounteredAt).format('YYYY-MM-DD HH:mm:ss'));
            $('#exStackTrace').text(data.stackTrace);
            $('#exReqBody').text(data.requestBody);
            $('#exPath').text(data.path);
            $('#exMethod').text(data.method);
            $('#exQuery').text(data.queryString);

            if (data.stackTrace != null && data.stackTrace !== "") {
                document.getElementById("exStackTraceCopy").style.display = "block";
                var element = document.getElementById("exStackTrace");
                if (data.stackTrace.includes("{")) {
                    var obj = JSON.parse(element.innerText);
                    element.innerHTML = JSON.stringify(obj, undefined, 2);
                }
            } else {
                document.getElementById("exReqBodyCopy").style.display = "none";
            }
            if (data.requestBody != null && data.requestBody !== "") {
                document.getElementById("exReqBodyCopy").style.display = "block";
                var element2 = document.getElementById("exReqBody");
                if (data.requestBody.includes("{")) {
                    var obj2 = JSON.parse(element2.innerText);
                    element2.innerHTML = JSON.stringify(obj2, undefined, 2);
                }
            } else {
                document.getElementById("exReqBodyCopy").style.display = "none";
            }
        }

        function populateInCodeModal(data) {
            $('#incodeFrom').text(data.callingFrom);
            $('#incodeLine').text(data.lineNumber);
            $('#incodeMethod').text(data.callingMethod);
            $('#incodeTime').text(moment(data.timestamp).format('YYYY-MM-DD HH:mm:ss'));
            $('#incodeLogLevel').text(data.logLevel);
            $('#incodeMessage').text(data.message);
            $('#incodeEventId').text(data.eventId);

            if (data.message != null && data.message !== "") {
                document.getElementById("incodeMessageCopy").style.display = "block";
            } else {
                document.getElementById("incodeMessageCopy").style.display = "none";
            }
        }

        function sleep(time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        function copyToClipboard(e, id, tag) {
            var copyText = document.getElementById(id).innerHTML;
            navigator.clipboard.writeText(copyText);

            /* Alert the copied text */
            document.getElementById(tag).innerHTML = "Copied!";

            sleep(1500).then(() => {
                document.getElementById(tag).innerHTML = "Copy";
            });
            e = e || window.event;
            e.preventDefault();
        }

        function truncate(str, num) {
            if (str.length > num) {
                return str.slice(0, num) + "...";
            } else {
                return str;
            }
        }
    </script>

</body>
</html>
